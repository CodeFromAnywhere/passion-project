<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Passion Project</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF69B4',
                        secondary: '#FFA07A',
                    },
                    borderRadius: {
                        'xl': '1rem',
                    },
                },
            },
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
        }
    </style>
</head>

<body class="bg-gradient-to-r from-pink-100 to-orange-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-primary mb-2">The Passion Project</h1>
            <p class="text-lg text-gray-600">Turn your challenges into stepping stones for your passions!</p>
        </header>

        <div id="loading"
            class="fixed top-0 left-0 w-full h-full bg-white bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-primary"></div>
        </div>

        <button id="logoutBtn"
            class="absolute top-4 right-4 bg-secondary text-white px-4 py-2 rounded-full hover:bg-opacity-80 transition duration-300">
            Logout
        </button>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-primary mb-4">Add a New Goal</h2>
                <form id="goalForm" class="space-y-4">
                    <div>
                        <label for="challenge" class="block text-sm font-medium text-gray-700">Challenge:</label>
                        <input type="text" id="challenge" name="challenge" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="reason" class="block text-sm font-medium text-gray-700">Because:</label>
                        <input type="text" id="reason" name="reason" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="passion" class="block text-sm font-medium text-gray-700">Passion/Result:</label>
                        <input type="text" id="passion" name="passion" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50">
                    </div>
                    <button type="submit"
                        class="w-full bg-primary text-white px-4 py-2 rounded-full hover:bg-opacity-80 transition duration-300">Add
                        Goal</button>
                </form>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-primary mb-4">Weekly Progress</h2>
                <form id="progressForm" class="space-y-4">
                    <div>
                        <label for="goalSelect" class="block text-sm font-medium text-gray-700">Select Goal:</label>
                        <select id="goalSelect" name="goalId" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50">
                            <option value="">Select a goal</option>
                        </select>
                    </div>
                    <div>
                        <label for="weekNumber" class="block text-sm font-medium text-gray-700">Week Number:</label>
                        <input type="number" id="weekNumber" name="weekNumber" required readonly
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="status" class="block text-sm font-medium text-gray-700">Status:</label>
                        <select id="status" name="status" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50">
                            <option value="success">Success</option>
                            <option value="failed">Failed</option>
                            <option value="in progress">In Progress</option>
                        </select>
                    </div>
                    <button type="submit"
                        class="w-full bg-secondary text-white px-4 py-2 rounded-full hover:bg-opacity-80 transition duration-300">Update
                        Progress</button>
                </form>
            </div>
        </div>

        <div id="goalsList" class="mt-8 space-y-4"></div>
    </div>

    <script>
        const API_URL = 'https://data.actionschema.com';
        const authToken = localStorage.getItem('authToken');

        if (!authToken) {
            window.location.href = '/';
        }

        const showLoading = () => document.getElementById('loading').classList.remove('hidden');
        const hideLoading = () => document.getElementById('loading').classList.add('hidden');

        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('authToken');
            window.location.href = '/';
        });

        const fetchGoals = async () => {
            showLoading();
            try {
                const response = await fetch(`${API_URL}/passion_project_goals/read`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({})
                });
                const data = await response.json();
                if (data.isSuccessful) {
                    updateGoalsList(data.items);
                    updateGoalSelect(data.items);
                }
            } catch (error) {
                console.error('Error fetching goals:', error);
            } finally {
                hideLoading();
            }
        };

        const updateGoalsList = (goals) => {
            const goalsList = document.getElementById('goalsList');
            goalsList.innerHTML = '';
            Object.values(goals).forEach(goal => {
                const goalElement = document.createElement('div');
                goalElement.className = 'bg-white p-6 rounded-xl shadow-lg';
                goalElement.innerHTML = `
                    <h3 class="text-xl font-semibold text-primary mb-2">${goal.challenge}</h3>
                    <p class="text-gray-600 mb-2">Because: ${goal.reason}</p>
                    <p class="text-gray-600 mb-4">Passion/Result: ${goal.passion}</p>
                    <h4 class="text-lg font-semibold text-secondary mb-2">Weekly Progress:</h4>
                    <div id="progress-${goal.id}" class="space-y-2"></div>
                `;
                goalsList.appendChild(goalElement);
                fetchWeeklyProgress(goal.id);
            });
        };

        const updateGoalSelect = (goals) => {
            const goalSelect = document.getElementById('goalSelect');
            goalSelect.innerHTML = '<option value="">Select a goal</option>';
            Object.entries(goals).forEach(([id, goal]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = goal.challenge;
                goalSelect.appendChild(option);
            });
        };

        const fetchWeeklyProgress = async (goalId) => {
            showLoading();
            try {
                const response = await fetch(`${API_URL}/passion_project_weekly_progress/read`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        filter: [
                            { operator: 'equal', value: goalId, objectParameterKey: 'goalId' }
                        ]
                    })
                });
                const data = await response.json();
                if (data.isSuccessful) {
                    updateWeeklyProgress(goalId, data.items);
                }
            } catch (error) {
                console.error('Error fetching weekly progress:', error);
            } finally {
                hideLoading();
            }
        };

        const updateWeeklyProgress = (goalId, progress) => {
            const progressContainer = document.getElementById(`progress-${goalId}`);
            progressContainer.innerHTML = '';
            Object.values(progress).forEach(week => {
                const weekElement = document.createElement('div');
                weekElement.className = 'flex items-center space-x-2';
                const icon = week.status === 'success' ? 'fa-check text-green-500' : (week.status === 'failed' ? 'fa-times text-red-500' : 'fa-circle-notch text-yellow-500');
                weekElement.innerHTML = `
                    <span class="text-gray-600">Week ${week.weekNumber}:</span>
                    <i class="fas ${icon}"></i>
                    <span class="capitalize">${week.status}</span>
                `;
                progressContainer.appendChild(weekElement);
            });
        };

        document.getElementById('goalForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            const formData = new FormData(e.target);
            const goalData = Object.fromEntries(formData.entries());
            try {
                const response = await fetch(`${API_URL}/passion_project_goals/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ items: [goalData] })
                });
                const data = await response.json();
                if (data.isSuccessful) {
                    fetchGoals();
                    e.target.reset();
                }
            } catch (error) {
                console.error('Error creating goal:', error);
            } finally {
                hideLoading();
            }
        });

        document.getElementById('progressForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            const formData = new FormData(e.target);
            const progressData = Object.fromEntries(formData.entries());
            try {
                const response = await fetch(`${API_URL}/passion_project_weekly_progress/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ items: [progressData] })
                });
                const data = await response.json();
                if (data.isSuccessful) {
                    fetchWeeklyProgress(progressData.goalId);
                    e.target.reset();
                }
            } catch (error) {
                console.error('Error updating progress:', error);
            } finally {
                hideLoading();
            }
        });

        document.getElementById('weekNumber').value = Math.ceil((new Date() - new Date(new Date().getFullYear(), 0, 1)) / 604800000);

        fetchGoals();
    </script>
</body>

</html>